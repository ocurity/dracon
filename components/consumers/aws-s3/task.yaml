---
apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: consumer-aws-s3
  labels:
    v1.dracon.ocurity.com/component: consumer
spec:
  volumes:
    - name: scratch
      emptyDir: {}
  params:
    - name: consumer-aws-s3-access-key-id
      type: string
    - name: consumer-aws-s3-secret-access-key
      type: string
    - name: consumer-aws-s3-bucket-name
      type: string
    - name: consumer-aws-s3-bucket-region
      type: string
  workspaces:
    - name: source-code-ws
      description: The workspace containing the source-code to scan.
  steps:
    - name: run-consumer
      imagePullPolicy: IfNotPresent
      image: '{{ default "ghcr.io/ocurity/dracon" .Values.container_registry }}/components/consumers/aws-s3:{{ default "latest" .Values.dracon_os_component_version }}'
      env:
        - name: AWS_ACCESS_KEY_ID
          value: "$(params.consumer-aws-s3-access-key-id)"
        - name: AWS_SECRET_ACCESS_KEY
          value: "$(params.consumer-aws-s3-secret-access-key)"
      command: ["/app/components/consumers/aws-s3/aws-s3"]
      args:
        [
          "-in",
          "$(workspaces.source-code-ws.path)/.dracon/enrichers/",
          "-bucket",
          "$(params.consumer-aws-s3-bucket-name)",
          "-region",
          "$(params.consumer-aws-s3-bucket-region)",
        ]
      volumeMounts:
        - mountPath: /scratch
          name: scratch
