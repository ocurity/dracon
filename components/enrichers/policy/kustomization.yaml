# DO NOT EDIT. Code generated by:
# github.com/ocurity/dracon/bin/kustomize-component-generator.

apiVersion: kustomize.config.k8s.io/v1alpha1
kind: Component
resources:
  - task.yaml
patches:
  # Add the Task to the Tekton Pipeline.
  - patch: |
      apiVersion: tekton.dev/v1beta1
      kind: Pipeline
      metadata:
        name: unused
      spec:
        workspaces:
          - name: output
        tasks:
          - name: enricher-policy
            taskRef:
              name: enricher-policy
            workspaces:
              - name: output
                workspace: output
            params:
              - name: enricher-policy-base64-policy
                value: $(params.enricher-policy-base64-policy)
              - name: enricher-policy-annotation
                value: $(params.enricher-policy-annotation)
        params:
          - name: enricher-policy-base64-policy
            type: string
            default: cGFja2FnZSBleGFtcGxlLmdvc2VjCgpkZWZhdWx0IGFsbG93IDo9IGZhbHNlCgphbGxvdyA9dHJ1ZSB7CiAgICBwcmludChpbnB1dCkKICAgIGNoZWNrX3NldmVyaXR5Cn0KCmNoZWNrX3NldmVyaXR5IHsKICAgIGlucHV0LnNldmVyaXR5ID09ICJTRVZFUklUWV9ISUdIIgp9CmNoZWNrX3NldmVyaXR5IHsKICAgIGlucHV0LnNldmVyaXR5ID09ICJTRVZFUklUWV9NRURJVU0iCn0KY2hlY2tfc2V2ZXJpdHkgewogICAgaW5wdXQuc2V2ZXJpdHkgPT0gIlNFVkVSSVRZX0xPVyIKfQ==
          - name: enricher-policy-annotation
            type: string
            default: ""
    target:
      kind: Pipeline
  # Add anchors to Task.
  - patch: |
      apiVersion: tekton.dev/v1beta1
      kind: Task
      metadata:
        name: enricher-policy
        labels:
          v1.dracon.ocurity.com/component: enricher
      spec:
        params:
          - name: anchors
            type: array
            description: A list of tasks that this task depends on using their anchors.
            default: []
        results:
          - name: anchor
            description: An anchor to allow other tasks to depend on this task.
        steps:
          - name: anchor
            image: docker.io/busybox:1.35.0
            script: echo "$(context.task.name)" > "$(results.anchor.path)"
    target:
      kind: Task
      name: enricher-policy
  # If we have an producer-aggregator task in the pipeline (added by the
  # producer-aggregator component), make the enricher depend on the completion of
  # it.
  - patch: |
      apiVersion: tekton.dev/v1beta1
      kind: Pipeline
      metadata:
        name: unused
      spec:
        tasks:
          - name: enricher-policy
            params:
              - name: anchors
                value:
                  - $(tasks.producer-aggregator.results.anchor)
    target:
      kind: Pipeline
      annotationSelector: v1.dracon.ocurity.com/has-producer-aggregator=true
  # If we have an enricher-aggregator task in the pipeline (added by the
  # enricher-aggregator component), make it depend on the completion of this
  # enricher.
  - patch: |
      apiVersion: tekton.dev/v1beta1
      kind: Pipeline
      metadata:
        name: unused
      spec:
        tasks:
          - name: enricher-aggregator
            params:
              - name: anchors
                value:
                  - $(tasks.enricher-policy.results.anchor)
    target:
      kind: Pipeline
      annotationSelector: v1.dracon.ocurity.com/has-enricher-aggregator=true
